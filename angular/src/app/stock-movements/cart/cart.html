<div class="cart-page">
  <div class="mobile-header d-lg-none mb-3">
    <h5 class="fw-bold mb-3">
      <i class="fas fa-shopping-basket me-2"></i>Point of Sale
    </h5>
  </div>

  <div class="cart-container">
    <!-- LEFT: Product Catalog -->
    <div class="products-section">
      <div class="section-card">
        <div class="section-header">
          <h5 class="section-title mb-3">Products Catalog</h5>

          <div class="search-toolbar">
            <div class="search-wrapper">
              <i class="fas fa-search search-icon"></i>
              <input type="text" class="search-input" placeholder="Search products..." [(ngModel)]="search"
                (input)="onSearchInput()" />
            </div>

            <div class="filter-controls">
              <label class="stock-filter">
                <input type="checkbox" [(ngModel)]="showInStockOnly" (change)="onToggleInStockOnly()" />
                <span>In stock only</span>
              </label>

              <select *ngIf="isAdmin" class="branch-select" [(ngModel)]="branchId" (change)="onBranchChanged()">
                <option *ngFor="let b of branches" [value]="b.id">
                  {{ b.name }}
                </option>
              </select>
            </div>
          </div>

          <div class="admin-info" *ngIf="isAdmin">
            <span class="text-muted">
              Branch: <strong>{{ selectedBranchName }}</strong>
            </span>
            <span *ngIf="loadingStock" class="ms-2">
              <i class="fas fa-circle-notch fa-spin"></i> Loading stock...
            </span>
          </div>
        </div>

        <!-- Products grid (backend page) -->
        <div class="products-grid" *ngIf="products.length">
          <div class="product-card" *ngFor="let p of products">
            <div class="product-visual">
              <img *ngIf="imgSrc(p) as src; else productIcon" [src]="src" [alt]="p.productName || 'Product'"
                class="product-image" />
              <ng-template #productIcon>
                <div class="product-icon-wrapper">
                  <i [class]="iconFor(p)"></i>
                </div>
              </ng-template>

              <span class="stock-badge" [class.in-stock]="onHand(p) > 0" [class.out-of-stock]="onHand(p) === 0">
                {{ onHand(p) > 0 ? onHand(p) + ' in stock' : 'Out of stock' }}
              </span>
            </div>

            <div class="product-info">
              <h6 class="product-name">{{ p.productName }}</h6>
              <p class="product-code">{{ p.productNo }}</p>

              <span class="product-type">
                {{ p.productType || 'General' }}
              </span>
            </div>

            <div class="product-footer">
              <div class="product-price">
                <span class="currency">{{ currencySymbol }}</span>
                <span class="amount">
                  {{ p.sellingUnitPrice | number: '1.2-2' }}
                </span>
              </div>

              <button type="button" class="btn-add-to-cart" [class.added]="alreadyInCart(p)"
                [disabled]="!loadingStock && onHand(p) <= 0" (click)="addToCart(p)">
                <i class="fas fa-plus icon-add"></i>
                <i class="fas fa-check icon-check"></i>
                <span class="btn-text">
                  {{ alreadyInCart(p) ? 'Added' : 'Add' }}
                </span>
              </button>
            </div>
          </div>
        </div>

        <!-- Pagination (BACKEND) -->
        <div class="pagination-bar" *ngIf="totalCount > pageSize">
          <div class="pagination-info">
            Showing {{ pageStart }}–{{ pageEnd }} of {{ totalCount }} products
          </div>

          <div class="pagination-controls">
            <button type="button" class="pagination-button" (click)="prevPage()"
              [disabled]="currentPage === 1 || loadingStock">
              ‹ Prev
            </button>

            <span class="page-indicator">
              Page {{ currentPage }} / {{ totalPages }}
            </span>

            <button type="button" class="pagination-button" (click)="nextPage()"
              [disabled]="currentPage === totalPages || loadingStock">
              Next ›
            </button>

            <select class="page-size-select" [(ngModel)]="pageSize" (ngModelChange)="setPageSize($event)">
              <option *ngFor="let s of pageSizeOptions" [ngValue]="s">
                {{ s }} / page
              </option>
            </select>
          </div>
        </div>

        <!-- Empty state -->
        <div class="empty-state" *ngIf="!loadingStock && totalCount === 0">
          <i class="fas fa-search empty-icon"></i>
          <p class="empty-title">No products found</p>
          <p class="empty-subtitle">Try adjusting your search or filters</p>
        </div>
      </div>
    </div>

    <!-- RIGHT: Shopping Cart -->
    <div class="cart-section">
      <div class="section-card cart-card">
        <div class="cart-header">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="section-title">
              <i class="fas fa-shopping-cart me-2"></i>
              Cart
              <span class="cart-count" *ngIf="lines.length">
                {{ lines.length }}
              </span>
            </h5>

            <button type="button" class="btn-text-danger" (click)="clear()" *ngIf="lines.length">
              Clear
            </button>
          </div>
        </div>

        <div class="cart-content">
          <div class="cart-empty" *ngIf="!lines.length">
            <i class="fas fa-shopping-basket cart-empty-icon"></i>
            <p class="cart-empty-text">Your cart is empty</p>
            <p class="cart-empty-subtext">Add items from the catalog</p>
          </div>

          <div class="cart-items" *ngIf="lines.length">
            <div class="cart-item-compact" [class.has-error]="!!l.amountError"
              *ngFor="let l of lines; trackBy: trackByLine">
              <div class="item-row">
                <div class="item-info">
                  <div class="item-image">
                    <img *ngIf="imgSrc(l.product) as src; else itemIcon" [src]="src"
                      [alt]="l.product.productName || 'Product'" />
                    <ng-template #itemIcon>
                      <div class="item-icon">
                        <i [class]="iconFor(l.product)"></i>
                      </div>
                    </ng-template>
                  </div>

                  <div class="item-name-price">
                    <h6 class="item-name" [title]="l.product.productName">
                      {{ l.product.productName }}
                    </h6>

                    <div class="item-unit-price">
                      Unit: {{ currencySymbol }}
                      {{ l.unitPrice | number: '1.2-2' }}

                      <span class="stock-indicator" [class.low-stock]="onHand(l.product) < 5">
                        ({{ onHand(l.product) }} left)
                      </span>
                    </div>
                  </div>
                </div>

                <div class="item-actions">
                  <div class="quantity-control-compact">
                    <button type="button" class="qty-btn" (click)="dec(l)" [disabled]="l.quantity <= 1">
                      <i class="fas fa-minus"></i>
                    </button>

                    <input type="number" class="qty-input" [(ngModel)]="l.quantity" (ngModelChange)="qtyChanged(l)"
                      [min]="1" [max]="onHand(l.product)" />

                    <button type="button" class="qty-btn" (click)="inc(l)" [disabled]="l.quantity >= onHand(l.product)">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>

                  <!-- Show the line amount EX VAT (what will be posted) -->
                  <!-- <div class="line-total-compact">
                    {{ currencySymbol }}
                    {{ lineEx(l) | number: '1.2-2' }}
                  </div> -->

                  <button type="button" class="btn-remove-compact" (click)="remove(l)" title="Remove">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>

              <!-- Amount Ex VAT input -->
              <div class="amount-row">
                <label class="amount-label">
                  <i class="fas fa-money-bill-wave"></i> Amount (Ex VAT)
                </label>

                <div class="amount-right">
                  <!-- ALWAYS calculated: qty * unitPrice -->
                  <span class="amount-current">
                    {{ currencySymbol }} {{ calcEx(l) | number: '1.2-2' }}
                  </span>

                  <div class="amount-input-wrapper">
                    <input #amtInput type="number" class="amount-input" [class.input-error]="!!l.amountError"
                      [ngModel]="l.amountExclVat" (ngModelChange)="amountExChanged(l, $event, amtInput)" min="0"
                      step="0.01" placeholder="0.00" />
                  </div>
                </div>
              </div>

              <div class="amount-error" *ngIf="l.amountError">
                {{ l.amountError }}
              </div>
            </div>
          </div>
        </div>

        <div class="customer-panel" *ngIf="lines.length">
          <label class="customer-label">Customer name</label>
          <input type="text" class="customer-input" placeholder="Optional customer name..."
            [(ngModel)]="customerName" />
        </div>

        <div class="cart-summary" *ngIf="lines.length">
          <div class="summary-row">
            <span class="summary-label">Subtotal</span>
            <span class="summary-value">
              {{ currencySymbol }} {{ totals.ex | number: '1.2-2' }}
            </span>
          </div>

          <div class="summary-row">
            <span class="summary-label">
              VAT ({{ (vatRate * 100) | number: '1.0-0' }}%)
            </span>
            <span class="summary-value">
              {{ currencySymbol }} {{ totals.vat | number: '1.2-2' }}
            </span>
          </div>

          <div class="summary-divider"></div>

          <div class="summary-row summary-total">
            <span class="summary-label">Total</span>
            <span class="summary-value">
              {{ currencySymbol }} {{ totals.inc | number: '1.2-2' }}
            </span>
          </div>
        </div>

        <button type="button" class="btn-checkout" (click)="checkout()" [disabled]="!lines.length">
          <i class="fas fa-credit-card me-2"></i>
          Checkout
          <span class="checkout-amount" *ngIf="lines.length">
            {{ currencySymbol }} {{ totals.inc | number: '1.2-2' }}
          </span>
        </button>
      </div>
    </div>
  </div>
</div>