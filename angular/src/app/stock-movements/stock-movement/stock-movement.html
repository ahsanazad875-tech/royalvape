<div class="card stock-movement-card">
  <div class="card-header d-flex align-items-start justify-content-between gap-3">
    <div>
      <h2 class="mb-1">Stock Movements</h2>
      <p class="mb-0 text-muted">Royal Vapes – Sales &amp; Inventory</p>
    </div>

    <div class="text-muted small" *ngIf="totalCount() > 0">
      Showing <b>{{ visibleFrom() }}</b>–<b>{{ visibleTo() }}</b> of <b>{{ totalCount() }}</b>
    </div>
  </div>

  <div class="card-body">
    <!-- Filters -->
    <div class="card mb-3">
      <div
        class="card-header d-flex align-items-center justify-content-between stock-movement-filters-header"
        role="button"
        (click)="filtersCollapsed = !filtersCollapsed"
      >
        <span class="fw-semibold">Filters</span>
        <span class="stock-movement-toggle">{{ filtersCollapsed ? 'Show' : 'Hide' }}</span>
      </div>

      <div class="card-body" *ngIf="!filtersCollapsed">
        <form [formGroup]="form" (ngSubmit)="search()">
          <div class="row g-3 align-items-end">

            <!-- Branch -->
            <div class="col-12 col-md-6 col-lg-2" *ngIf="isAdmin">
              <label class="form-label">Branch</label>
              <nz-select class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="All" formControlName="branchId">
                <nz-option nzValue="" nzLabel="All"></nz-option>
                <nz-option *ngFor="let b of branches()" [nzValue]="b.id" [nzLabel]="b.name"></nz-option>
              </nz-select>
            </div>

            <!-- Product -->
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label">Product</label>
              <nz-select class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="All" formControlName="productId">
                <nz-option nzValue="" nzLabel="All"></nz-option>
                <nz-option *ngFor="let p of products()" [nzValue]="p.id" [nzLabel]="p.productNo + ' ' + p.productName"></nz-option>
              </nz-select>
            </div>

            <!-- Product Type -->
            <div class="col-12 col-md-6 col-lg-2">
              <label class="form-label">Product Type</label>
              <nz-select class="w-100" nzShowSearch nzAllowClear nzPlaceHolder="All" formControlName="productTypeId">
                <nz-option nzValue="" nzLabel="All"></nz-option>
                <nz-option *ngFor="let t of productTypes()" [nzValue]="t.id" [nzLabel]="t.type"></nz-option>
              </nz-select>
            </div>

            <!-- Movement Type -->
            <div class="col-12 col-md-6 col-lg-2">
              <label class="form-label">Movement Type</label>
              <nz-select class="w-100" nzAllowClear nzPlaceHolder="All" formControlName="stockMovementType">
                <nz-option *ngFor="let t of movementTypeOptions" [nzValue]="t.value" [nzLabel]="t.label"></nz-option>
              </nz-select>
            </div>

            <!-- From -->
            <div class="col-12 col-md-6 col-lg-2">
              <label class="form-label" for="dateFrom">From</label>
              <input id="dateFrom" type="datetime-local" class="form-control form-control-sm" formControlName="dateFrom" />
            </div>

            <!-- To -->
            <div class="col-12 col-md-6 col-lg-2">
              <label class="form-label" for="dateTo">To</label>
              <input id="dateTo" type="datetime-local" class="form-control form-control-sm" formControlName="dateTo" />
            </div>
            
            <!-- COLUMN SELECT -->
            <div class="col-12 col-md-6 col-lg-3">
              <label class="form-label">Show / Hide Columns</label>

              <button type="button" nz-button nz-dropdown nzType="default" nzTrigger="click"
                [nzDropdownMenu]="columnsMenu" class="w-100 d-flex justify-content-between align-items-center">
                <span>Columns ({{ visibleColumns.length }})</span>
                <i nz-icon nzType="down"></i>
              </button>

              <nz-dropdown-menu #columnsMenu="nzDropdownMenu" [nzClickHide]="false">
                <ul nz-menu nzSelectable="false" class="p-2 column-dropdown">
                  <li nz-menu-item *ngFor="let col of columns" class="d-flex align-items-center gap-2">
                    <input type="checkbox" class="form-check-input me-2" [checked]="col.visible"
                      (click)="$event.stopPropagation()"
                      (change)="toggleColumn(col.key, $any($event.target).checked)" />
                    <span>{{ col.label }}</span>
                  </li>
                </ul>
              </nz-dropdown-menu>
            </div>

            <!-- Include cancelled -->
            <div class="col-12 col-md-6 col-lg-2">
              <label class="form-label d-block">&nbsp;</label>
              <label nz-checkbox formControlName="includeCancelled">Include cancelled</label>
            </div>


            <!-- Actions -->
            <div class="col-12 col-lg-3 ms-lg-auto">
              <div class="d-flex justify-content-end gap-2 flex-wrap">
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="reset()" [disabled]="loading()">
                  Reset
                </button>
                <button type="submit" class="btn btn-primary btn-sm" [disabled]="loading()">
                  Search
                </button>
              </div>
            </div>

          </div>
        </form>
      </div>
    </div>

    <!-- Table -->
    <div class="stock-movement-table-wrap">
      <nz-table
        [nzData]="rows()"
        [nzLoading]="loading()"
        [nzFrontPagination]="false"
        [nzTotal]="totalCount()"
        [nzPageIndex]="pageIndex()"
        [nzPageSize]="pageSize()"
        [nzShowSizeChanger]="true"
        [nzPageSizeOptions]="[10, 25, 50, 100]"
        nzTableLayout="fixed"
        (nzQueryParams)="onQueryParamsChange($event)"
      >
        <thead>
          <tr>
            <th *ngFor="let col of visibleColumns"
                [nzWidth]="col.width"
                [nzColumnKey]="col.key"
                [nzSortFn]="col.sortable"
                [ngClass]="col.class"
                [nzSortOrder]="sortOrder(col.key)">
              {{ col.label }}
            </th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let r of rows(); trackBy: trackRow">
            <td *ngFor="let col of visibleColumns" [ngClass]="col.class">
              <ng-container [ngSwitch]="col.key">
                <ng-container *ngSwitchCase="'MovementDate'">{{ r.movementDate | date: 'dd MMM yyyy HH:mm' }}</ng-container>
                <ng-container *ngSwitchCase="'BranchName'">
                  <span nz-tooltip [nzTooltipTitle]="r.branchName" class="cell-ellipsis">{{ r.branchName }}</span>
                </ng-container>
                <ng-container *ngSwitchCase="'StockMovementNo'">
                  <span nz-tooltip [nzTooltipTitle]="r.stockMovementNo" class="cell-ellipsis">{{ r.stockMovementNo }}</span>
                </ng-container>
                <ng-container *ngSwitchCase="'StockMovementType'">
                  <nz-tag [nzColor]="movementTypeTagColor(r.stockMovementType)">
                    {{ movementTypeLabel(r.stockMovementType) }}
                  </nz-tag>
                </ng-container>
                <ng-container *ngSwitchCase="'ProductName'">
                  <span nz-tooltip [nzTooltipTitle]="r.productName" class="cell-ellipsis">{{ r.productName }}</span>
                </ng-container>
                <ng-container *ngSwitchCase="'ProductType'">
                  <span nz-tooltip [nzTooltipTitle]="r.productType" class="cell-ellipsis">{{ r.productType }}</span>
                </ng-container>
                <ng-container *ngSwitchCase="'QuantitySigned'" class="text-end">{{ r.quantitySigned | number:'1.0-2' }}</ng-container>
                <ng-container *ngSwitchCase="'UnitPrice'" class="text-end">{{ (r.unitPrice ?? 0) | number:'1.0-2' }}</ng-container>
                <ng-container *ngSwitchCase="'AmountExclVat'" class="text-end">{{ (r.amountExclVat ?? 0) | number:'1.0-2' }}</ng-container>
              </ng-container>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </div>
  </div>
</div>